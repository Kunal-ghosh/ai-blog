
name: Auto Generate AI Blog Post

on:
  schedule:
    # - cron: '0 6 * * *'   # Every day at 06:00 UTC
    - cron: '*/2 * * * *'  # Example: every 30 min (avoid spamming every 3 min)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Setup Git identity
        run: |
          git config --global user.name "Kunal-ghosh"
          git config --global user.email "kunalghosh5135@gmail.com"

      - name: Debug file tree
        run: |
          set -e
          CANDIDATES=("pages/utils/generatePost.js" "utils/generatePost.js" "pages/generatePost.js" "scripts/generatePost.js")
          FOUND=""
          for p in "${CANDIDATES[@]}"; do
            if [ -f "$p" ]; then FOUND="$p"; break; fi
          done
          if [ -z "$FOUND" ]; then
            echo "❌ generatePost.js not found. Checked: ${CANDIDATES[*]}"
            echo "Current tree:"
            ls -R
            exit 1
          fi
          echo "✅ Using $FOUND"
          node "$FOUND"


      - name: Generate AI Post
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: node utils/generatePost.js

      - name: Show generated posts
        run: |
          echo "Files in pages/posts:"
          ls -la pages/posts

      - name: Print latest generated post
        run: |
          FILE=$(ls -t pages/posts/*.js | head -n1)
          echo "✅ Latest generated file: $FILE"
          echo "---- FILE CONTENT ----"
          cat "$FILE"
          echo "----------------------"

      - name: Commit generated post (to main)
        run: |
          git add pages/posts
          git commit -m "Add auto-generated post [skip ci]" || echo "No changes"
          # Re-point remote to use token so push is authenticated
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          git push origin HEAD:main

      - name: Build site
        run: npm run build

      - name: Deploy to GitHub Pages (gh-pages npm)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # gh-pages reads GITHUB_TOKEN or GH_TOKEN
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run deploy
